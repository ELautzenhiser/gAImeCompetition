{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}New Game{% endblock %}</h1>
{% endblock %}

{% block content %}

  <style>
    textarea {
      height: 100px;
      width: 90%;
    }

    input {
      display: block;
    }
  </style>

  <br>
  <form method="post">
    <label for="title">Title</label>
    <input name="title" id="title" value="{{ title }}" required>
    <br>
    <label for="description">Description</label>
    <textarea name="description" id="description">{{ description }}</textarea>
    <br>
    <select id="min_players" name="min_players">
    {% for i in range(2,9) %}
      <option value="{{ i }}" {% if min_players==i %}selected{% endif %}>{{ i }}</option>
    {% endfor %}
    </select>
    <label for="min_players">Minimum number of players</label>
    <br>
    <select id="max_players" name="max_players">
    {% for i in range(2,9) %}
      <option value="{{ i }}" {% if max_players==i %}selected{% endif %}>{{ i }}</option>
    {% endfor %}
    </select>
    <label for="max_players">Maximum number of players</label>
    <br><br>
    <input type=file id="referee_file">
    <br><br>
    <label for="referee_code">Code</label>
    <textarea name="referee_code" id="referee_code">{{ referee_code }}</textarea>
    <div id="referee_ace"></div>
    <input type="submit" value="Save">
  </form>

  <script src="/static/js/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
  <script>
    function createEditor(name) {
      // find the textarea
      var textarea = document.querySelector("form textarea[name='" + name + "']");

      // create ace editor
      var editor = ace.edit("referee_ace")
      editor.container.style.height = "200px"
      editor.container.style.width = "100%"
      editor.session.setValue(textarea.value)
      // replace textarea with ace
      textarea.parentNode.insertBefore(editor.container, textarea)
      textarea.style.display = "none"
      // find the parent form and add submit event listener
      var form = textarea
      while (form && form.localName != "form") form = form.parentNode
      form.addEventListener("submit", function() {
        // update value of textarea to match value in ace
        textarea.value = editor.getValue()
      }, true)
    }
    createEditor("referee_code")

    function handleFileSelect(evt) {
      var files = evt.target.files
      f = files[0]

      var reader = new FileReader()

      reader.onload = (function(theFile) {
        return function(e) {
          var editor = ace.edit("referee_ace")
          var session = editor.getSession()
          session.setValue( e.target.result )
        }
      })(f)

      reader.readAsText(f)
    }
    document.getElementById('referee_file').addEventListener('change', handleFileSelect, false)
  </script>
{% endblock %}


